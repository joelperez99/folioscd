# app.py ‚Äî Esc√°ner PDFs en Google Drive (Service Account listo para Streamlit Cloud)
# Extrae el n√∫mero despu√©s de "Venta DM ..." y el FOLIO de cada PDF en una carpeta de Drive.

import os, io, re, tempfile, json
from typing import List, Tuple, Dict

import pandas as pd
import streamlit as st
from unidecode import unidecode
from pdfminer.high_level import extract_text

from pydrive2.auth import GoogleAuth
from pydrive2.drive import GoogleDrive

st.set_page_config(page_title="Esc√°ner PDFs (Drive) ‚Äî Venta DM + FOLIO", page_icon="üìÑ", layout="wide")
st.title("üìÑ Esc√°ner de PDFs en Google Drive ‚Üí Venta DM & FOLIO")
st.caption("Pega la URL o el ID de la carpeta en Google Drive, escanea PDFs y descarga un Excel.")

# --------------------- Utilidades ---------------------
VENTA_DM_REGEXES = [
    r"venta\s*dm[^\d]{0,30}[-:]\s*([0-9]{6,})",
    r"venta\s*dm[^\d]{0,30}\s+([0-9]{6,})",
]
FOLIO_REGEXES = [
    r"folio\s*[:\-]\s*([A-Z0-9\-\/]{3,})",
    r"\bfolio\b\s+([A-Z0-9\-\/]{3,})",
]

def normalize_text(txt: str) -> str:
    t = unidecode(txt or "")
    t = re.sub(r"[ \t]+", " ", t)
    return t

def extract_fields_from_text(text: str) -> Tuple[str, str]:
    t = normalize_text(text).lower()
    venta_dm, folio = "", ""
    for pat in VENTA_DM_REGEXES:
        m = re.search(pat, t, flags=re.IGNORECASE | re.DOTALL)
        if m:
            venta_dm = m.group(1).strip()
            break
    for pat in FOLIO_REGEXES:
        m = re.search(pat, t, flags=re.IGNORECASE | re.DOTALL)
        if m:
            folio = m.group(1).strip().strip(".;,")
            break
    return venta_dm, folio

def parse_folder_id_from_input(folder_input: str) -> str:
    s = (folder_input or "").strip()
    if not s:
        return ""
    m = re.search(r"/folders/([a-zA-Z0-9_\-]{10,})", s)
    if m: return m.group(1)
    m = re.search(r"[?&]id=([a-zA-Z0-9_\-]{10,})", s)
    if m: return m.group(1)
    return s

# --------------------- Autenticaci√≥n Drive ---------------------
def drive_with_service_account() -> GoogleDrive:
    """
    Usa una cuenta de servicio (ideal para Streamlit Cloud).
    Requiere que el secreto ST.secrets['GDRIVE_SERVICE_JSON'] exista.
    Debes compartir la carpeta de Drive con el email de la cuenta de servicio como "Lector".
    """
    sa_json = st.secrets.get("GDRIVE_SERVICE_JSON", None)
    if not sa_json:
        return None

    # Guardar JSON a disco temporal
    sa_path = "service_account.json"
    if isinstance(sa_json, dict):
        open(sa_path, "w", encoding="utf-8").write(json.dumps(sa_json))
    else:
        open(sa_path, "w", encoding="utf-8").write(sa_json)

    gauth = GoogleAuth(settings={
        "client_config_backend": "service",
        "service_config": {
            "client_json_file_path": sa_path
        }
    })
    gauth.ServiceAuth()
    return GoogleDrive(gauth)

def drive_with_oauth_local() -> GoogleDrive:
    """
    Fallback para uso local (no Cloud). Requiere client_secrets.json en disco.
    """
    gauth = GoogleAuth()
    gauth.LoadCredentialsFile("credentials.json")
    if gauth.credentials is None:
        # En servidores no funciona. √ösalo solo local.
        gauth.LocalWebserverAuth()
    elif gauth.access_token_expired:
        gauth.Refresh()
    else:
        gauth.Authorize()
    gauth.SaveCredentialsFile("credentials.json")
    return GoogleDrive(gauth)

def get_drive() -> GoogleDrive:
    drv = drive_with_service_account()
    if drv is not None:
        return drv
    # Si no hay secreto de servicio, intentamos OAuth local (desarrollo)
    return drive_with_oauth_local()

# --------------------- Drive Helpers ---------------------
def list_pdfs_in_folder(drive: GoogleDrive, folder_id: str) -> List[Dict]:
    q = f"'{folder_id}' in parents and mimeType = 'application/pdf' and trashed = false"
    return [{"id": f["id"], "title": f["title"]} for f in drive.ListFile({"q": q}).GetList()]

def download_pdf_temp(drive: GoogleDrive, file_id: str) -> str:
    f = drive.CreateFile({"id": file_id})
    fd, tmp_path = tempfile.mkstemp(suffix=".pdf")
    os.close(fd)
    f.GetContentFile(tmp_path)
    return tmp_path

def extract_text_from_pdf(path: str) -> str:
    try:
        return extract_text(path) or ""
    except Exception:
        return ""

# --------------------- UI ---------------------
with st.expander("‚öôÔ∏è Instrucciones r√°pidas", expanded=False):
    st.markdown("""
**Modo recomendado (Cloud): Cuenta de servicio**
1) En Google Cloud Console: habilita **Google Drive API**.
2) Crea una **Cuenta de servicio** y genera una **clave JSON**.
3) En **Streamlit Cloud ‚Üí App ‚Üí Settings ‚Üí Secrets**, crea la clave `GDRIVE_SERVICE_JSON`
   y pega **todo** el JSON.
4) En Google Drive, **comparte la carpeta** con el **email** de la cuenta de servicio (rol *Lector*).

**Modo local**: coloca `client_secrets.json` junto a `app.py` y ejecuta `streamlit run app.py`.
""")

tab1, tab2 = st.tabs(["üîé Leer carpeta de Drive", "üì§ Subir PDFs manualmente"])

with tab1:
    folder_input = st.text_input(
        "Pega la **URL** o el **ID** de la carpeta en Google Drive:",
        placeholder="https://drive.google.com/drive/folders/xxxxxxxxxxxxxxxxxxxxxxxx"
    )
    scan = st.button("üöÄ Escanear PDFs", type="primary", use_container_width=True)

    if scan:
        folder_id = parse_folder_id_from_input(folder_input)
        if not folder_id:
            st.error("No pude detectar el **ID** de carpeta. Verifica la URL/ID.")
            st.stop()

        with st.spinner("Autenticando con Google Drive‚Ä¶"):
            try:
                drive = get_drive()
            except Exception as e:
                st.exception(e)
                st.stop()

        with st.spinner("Listando PDFs‚Ä¶"):
            try:
                files = list_pdfs_in_folder(drive, folder_id)
            except Exception as e:
                st.exception(e)
                st.stop()

        if not files:
            st.warning("No se encontraron PDFs en esa carpeta.")
        else:
            st.success(f"Encontrados {len(files)} PDFs. Escaneando‚Ä¶")
            prog = st.progress(0.0)
            rows = []
            for i, meta in enumerate(files, start=1):
                try:
                    tmp_pdf = download_pdf_temp(drive, meta["id"])
                    text = extract_text_from_pdf(tmp_pdf)
                    if "venta dm" not in normalize_text(text).lower():
                        os.remove(tmp_pdf)
                        prog.progress(i/len(files))
                        continue
                    venta_dm, folio = extract_fields_from_text(text)
                    rows.append({"archivo": meta["title"], "venta_dm": venta_dm, "folio": folio})
                    os.remove(tmp_pdf)
                except Exception:
                    rows.append({"archivo": meta.get("title", "(desconocido)"), "venta_dm": "", "folio": ""})
                prog.progress(i/len(files))

            df = pd.DataFrame(rows)
            if df.empty:
                st.warning("Se escanearon los PDFs pero ninguno conten√≠a 'Venta DM'.")
            else:
                st.dataframe(df, use_container_width=True, height=420)
                out = io.BytesIO()
                with pd.ExcelWriter(out, engine="openpyxl") as w:
                    df.to_excel(w, index=False, sheet_name="Resultados")
                st.download_button(
                    "‚¨áÔ∏è Descargar Excel",
                    data=out.getvalue(),
                    file_name="venta_dm_folios.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    use_container_width=True
                )

with tab2:
    st.write("Procesa PDFs sin Google Drive.")
    files = st.file_uploader("Sube uno o m√°s PDFs", type=["pdf"], accept_multiple_files=True)
    if files:
        rows = []
        for f in files:
            try:
                fd, tmp = tempfile.mkstemp(suffix=".pdf"); os.close(fd)
                with open(tmp, "wb") as h: h.write(f.read())
                text = extract_text_from_pdf(tmp)
                if "venta dm" in normalize_text(text).lower():
                    venta_dm, folio = extract_fields_from_text(text)
                    rows.append({"archivo": f.name, "venta_dm": venta_dm, "folio": folio})
                os.remove(tmp)
            except Exception:
                rows.append({"archivo": f.name, "venta_dm": "", "folio": ""})

        if rows:
            df = pd.DataFrame(rows)
            st.dataframe(df, use_container_width=True, height=360)
            out = io.BytesIO()
            with pd.ExcelWriter(out, engine="openpyxl") as w:
                df.to_excel(w, index=False, sheet_name="Resultados")
            st.download_button(
                "‚¨áÔ∏è Descargar Excel (subidos)",
                data=out.getvalue(),
                file_name="venta_dm_folios_subidos.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True
            )
